<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: renderers | Beerlington]]></title>
  <link href="http://beerlington.github.io/blog/categories/renderers/atom.xml" rel="self"/>
  <link href="http://beerlington.github.io/"/>
  <updated>2013-12-31T21:18:39-05:00</updated>
  <id>http://beerlington.github.io/</id>
  <author>
    <name><![CDATA[Peter Brown]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building a Custom CSV Renderer in Rails 3]]></title>
    <link href="http://beerlington.github.io/blog/2011/07/25/building-a-csv-renderer-in-rails-3/"/>
    <updated>2011-07-25T22:18:00-04:00</updated>
    <id>http://beerlington.github.io/blog/2011/07/25/building-a-csv-renderer-in-rails-3</id>
    <content type="html"><![CDATA[<p>This post will walk you through creating a simple renderer in Rails
3.</p>

<h2>What are renderers?</h2>

<p>A renderer in Rails is a way of customizing how content is rendered for
the browser or any client interacting with your web service. Rails has
a handful of built in rendering formats such as <em>html</em>, <em>xml</em>, and
<em>json</em>, and exposes an effortless method for adding additional custom rendering
functionality that can be shared among your controllers and
applications.</p>

<p>Custom renderers provide a standard, reusable interface for rendering content,
in turn allowing you to DRY up your application logic architecture.
This post will show you how to add a custom renderer that converts
ActiveRecord collections to a downloadable CSV format.</p>

<p>Below is an example of how the final CSV renderer will be used:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>CSV rendering from a controller &ndash; app/locations_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">LocationsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@locations = Location.all</span>
</span><span class='line'>
</span><span class='line'><span class="sr">respond_to do |format|</span>
</span><span class='line'><span class="sr">  format.html</span>
</span><span class='line'><span class="sr">  format.csv  { render :csv =&amp;gt; @locations, :except =&amp;gt; [:id] }</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Some background info:</h2>

<p>Before getting started with our CSV renderer, let&rsquo;s look at the
<a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal/renderers.rb">Rails source</a>
to see how it defines its own custom renderers:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>actionpack/lib/action_controller/metal/renderers.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_renderer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">block</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;Renderers.add(key, &amp;amp;block)</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">module</span> <span class="nn">Renderers</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;# Lots of ommitted code...</span>
</span><span class='line'>
</span><span class='line'><span class="sr">def self.add(key, &amp;amp;block)</span>
</span><span class='line'><span class="sr">  define_method(&quot;_render_option_</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="sr">&quot;, &amp;amp;block)</span>
</span><span class='line'><span class="sr">  RENDERERS[key] = block</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'>
</span><span class='line'><span class="sr"># More ommitted code...</span>
</span><span class='line'>
</span><span class='line'><span class="sr">add :xml do |xml, options|</span>
</span><span class='line'><span class="sr">  self.content_type ||= Mime::XML</span>
</span><span class='line'><span class="sr">  xml.respond_to?(:to_xml) ? xml.to_xml(options) : xml</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>At the top you see an <em>add_renderer</em> method, which will be our
interface to add a custom renderer. Ignoring the fact that
I&rsquo;ve removed some of the implementation details,
further down you see a class method called <em>add</em> which does two things:
1) It defines an internal method used by the rendering stack,
and 2) stores the key (:xml, :json, etc) in a hash.</p>

<p>As we move to the bottom of this file, you&rsquo;ll see where <em>add</em> is being used
to define an XML renderer. This method takes a block with two arguments.
The first argument is an object that responds to <em>to_xml</em>, and the second
is a set of options that are passed as arguments to <em>to_xml</em>. If for some reason
the object doesn&rsquo;t respond to <em>to_xml</em> then it simply returns itself.</p>

<p>If you&rsquo;ve ever used the Rails scaffold generator, you will notice that
it includes code for responding to XML requests:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>default scaffolded controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>  <span class="vi">@location</span> <span class="o">=</span> <span class="no">Location</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  respond_to do |format|&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># show.html.erb</span>
</span><span class='line'><span class="nb">format</span><span class="o">.</span><span class="n">xml</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:xml</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="vi">@location</span> <span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This is exacly what adding the XML renderer has provided, a clean syntax
for allowing the server to respond with XML formatted data.</p>

<h2>Why should I use it?</h2>

<p>Let&rsquo;s say you have a <em>Location</em> model with the
following schema:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>db/schema.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Schema</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">20110726022558</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">create_table</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">locations</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span> <span class="ss">:force</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;t.string   &quot;name&quot;</span>
</span><span class='line'><span class="sr">t.string   &quot;address&quot;</span>
</span><span class='line'><span class="sr">t.string   &quot;city&quot;</span>
</span><span class='line'><span class="sr">t.string   &quot;state&quot;</span>
</span><span class='line'><span class="sr">t.string   &quot;zip&quot;</span>
</span><span class='line'><span class="sr">t.datetime &quot;created_at&quot;</span>
</span><span class='line'><span class="sr">t.datetime &quot;updated_at&quot;</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Although your main application may use all of these fields, you might need to
import this data into some sort of enterprise/exchange-powered legacy
system in CSV format. You could easily define a <em>to_csv</em> class method on your
Location model and just call that from the controller, but that presents
a few problems. The Location model shouldn&rsquo;t know anything
about converting itself to a CSV format because this violates the rule that
components should have a single, well-defined purpose. Also, what if you want to
download other models in CSV format? These are problems that respond_to and render
aim to solve.</p>

<h2>How does it work?</h2>

<p>Looking back to the first code snippet I posted, you can see that the
CSV render syntax in my controller is very similar to the XML render syntax. The only difference is
that our CSV format allows you to specify which columns (attributes) you
want to include or exclude in the downloaded CSV file. This detail has
almost nothing to do with the renderer itself, and is implemented by
the object&rsquo;s Array class, as shown below.</p>

<p>To understand how this works, let&rsquo;s look at our custom CSV renderer:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>csv_renderer.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">action_controller</span><span class="o">/</span><span class="n">metal</span><span class="o">/</span><span class="n">renderers</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;ActionController.add_renderer :csv do |csv, options|</span>
</span><span class='line'><span class="sr">  self.response_body = csv.respond_to?(:to_csv) ? csv.to_csv(options) : csv</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>You will notice a few differences between our custom renderer
and the XML renderer defined by Rails. First, we are using
<em>add_renderer</em> as opposed to just <em>add</em>. This is a personal preference
as you can also use: <code>ActionController::Renderers.add
:csv</code>. Both methods accomplish exactly the same thing, but I find
<em>add_renderer</em> to be slightly more readable.
Second, we are not setting the content_type. The
reason for this is because Rails automatically adds a CSV Mime Type
within the action_pack library. I&rsquo;m not going to go into the details of how that
works, but feel free to <a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/http/mime_types.rb">explore the complete list of Mime Types</a>.
The last detail to note is that we are requiring
<em>action_controller/metal/renderers</em> which provides us access to the <em>add_renderer</em>
method. You could alternatively require any module that inclues this
file, such as <em>action_controller/base</em> if you need access to methods like
<a href="http://api.rubyonrails.org/classes/ActionController/Streaming.html#method-i-send_data">send_data</a>.</p>

<p>Finally, let&rsquo;s look at the <em>to_csv</em> Array method. The
reason this method is defined on Array is because ActiveRecord converts
collection queries such as <code>Location.where(:state =&gt; 'vt')</code> or <code>Location.all</code>
to arrays.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>array.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">Array</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  # Converts an array to CSV formatted string</span>
</span><span class='line'><span class="sr">  # Options include:</span>
</span><span class='line'><span class="sr">  # :only =&gt; [:col1, :col2] # Specify which columns to include</span>
</span><span class='line'><span class="sr">  # :except =&gt; [:col1, :col2] # Specify which columns to exclude</span>
</span><span class='line'><span class="sr">  # :add_methods =&gt; [:method1, :method2] # Include addtional methods that aren&amp;rsquo;t columns</span>
</span><span class='line'><span class="sr">  def to_csv(options={})&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">empty?</span>
</span><span class='line'><span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">unless</span> <span class="n">first</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:column_names</span>
</span><span class='line'>
</span><span class='line'><span class="n">columns</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">column_names</span>
</span><span class='line'><span class="n">columns</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:only</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="ss">:to_s</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:only</span><span class="o">]</span>
</span><span class='line'><span class="n">columns</span> <span class="o">-=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:except</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="ss">:to_s</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:except</span><span class="o">]</span>
</span><span class='line'><span class="n">columns</span> <span class="o">+=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:add_methods</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="ss">:to_s</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:add_methods</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">csv</span> <span class="o">=</span> <span class="o">[</span><span class="n">columns</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'><span class="n">csv</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">columns</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="n">csv</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Above we can see that <em>to_csv</em> takes a hash of options which are used to
determine which columns should be included in the CSV file. One
option <code>:only =&gt; [:col1, :col2]</code> allows you to specify the exact
columns you want included, another option, <code>:except =&gt; [:col1, :col2]</code>,
allows you to specify which columns you DO NOT want to include, and the
last option, <code>:add_methods =&gt; [:method1, :method2]</code> allows you to add
data defined in methods that aren&rsquo;t saved in the database. Calling
<em>to_csv</em> without any arguments will include all columns.</p>

<h2>Usage examples:</h2>

<p>Tying that all together, we can now use this renderer in our controllers
to let users or clients download CSV data. Here are a few examples:</p>

<h3>Generate a CSV that includes every column:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/location_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">LocationsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@locations = Location.all</span>
</span><span class='line'>
</span><span class='line'><span class="sr">respond_to do |format|</span>
</span><span class='line'><span class="sr">  format.csv  { render :csv =&amp;gt; @locations }</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Generate a CSV that includes every column except the id:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/location_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">LocationsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@locations = Location.all</span>
</span><span class='line'>
</span><span class='line'><span class="sr">respond_to do |format|</span>
</span><span class='line'><span class="sr">  format.csv  { render :csv =&amp;gt; @locations, :except =&amp;gt; [:id] }</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Generate a CSV that includes only the state and zipcode:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/location_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">LocationsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@locations = Location.all</span>
</span><span class='line'>
</span><span class='line'><span class="sr">respond_to do |format|</span>
</span><span class='line'><span class="sr">  format.csv  { render :csv =&amp;gt; @locations, :only =&amp;gt; [:state, :zip] }</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Generate a CSV that adds a model method:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/location_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">LocationsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@locations = Location.all</span>
</span><span class='line'>
</span><span class='line'><span class="sr">respond_to do |format|</span>
</span><span class='line'><span class="sr">  format.csv  { render :csv =&amp;gt; @locations, :add_methods =&amp;gt; [:my_method] }</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Finishing up</h2>

<p>This post walked you through a simple yet practical approach to building
a custom Rails renderer in Rails 3. While it may be overkill for one-off
uses in a small code base, it shows it&rsquo;s true potential in large
applications by helping prevent redundant code, and for building APIs that may need to
respond to formats other than JSON and XML.</p>

<h2>Additional Resources</h2>

<p>All the code used in this post was developed for a RubyGem called <a href="https://github.com/beerlington/render_csv">render_csv</a>.
For more information about renderers and the Rails rendering stack, I highly recommend
<a href="http://pragprog.com/book/jvrails/crafting-rails-applications">Crafting Rails Applications</a>
 by <a href="https://twitter.com/josevalim">José Valim</a>. Also, the <a href="http://guides.rubyonrails.org/layouts_and_rendering.html">Layouts and Rendering Rails Guide</a>
provides a comprehensive overview of rendering in controllers as well as
views.</p>
]]></content>
  </entry>
  
</feed>
